<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Over Lab | Speaker Crossover Designer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>X-Over Lab</h1>
            <p>Precision 2-Way Speaker Crossover Designer</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="home">Home</button>
            <button class="tab-btn" data-tab="simple">Textbook</button>
            <button class="tab-btn" data-tab="advanced">Real-World Passive</button>
            <button class="tab-btn" data-tab="complex">Multi-Way</button>
            <button class="tab-btn" data-tab="tone">Tone Generator</button>
        </div>

        <!-- Home View -->
        <div id="home-view" class="tab-view">
            <div class="spectrum-card">
                <h2>Audio Frequency Spectrum</h2>
                <p>Understanding which sound lives in each frequency range is essential for designing great speakers.
                </p>

                <div class="frequency-chart">
                    <div class="chart-band sub-bass" data-name="Sub-Bass" data-range="20-60 Hz"
                        data-desc="The 'vibration' you feel. Kick drums and deep bass notes."></div>
                    <div class="chart-band bass" data-name="Bass" data-range="60-250 Hz"
                        data-desc="The power and 'thump' of the music. Pianos and lower guitars."></div>
                    <div class="chart-band low-mid" data-name="Low Midrange" data-range="250-500 Hz"
                        data-desc="Added warmth and fullness. Lower vocal registers."></div>
                    <div class="chart-band midrange" data-name="Midrange" data-range="500-2000 Hz"
                        data-desc="The heart of the sound. Vocals and most instruments."></div>
                    <div class="chart-band presence" data-name="Presence" data-range="2000-4000 Hz"
                        data-desc="Clarity and definition. The 'edge' of a voice or snare."></div>
                    <div class="chart-band brilliance" data-name="Brilliance" data-range="4000-6000 Hz"
                        data-desc="Detail and harmonics. The 'zing' of strings."></div>
                    <div class="chart-band treble" data-name="Treble / Air" data-range="6000-20000 Hz"
                        data-desc="The sparkle and atmosphere. Cymbals and air."></div>
                </div>

                <div id="spectrum-info" class="spectrum-info">
                    <h3 id="info-name">Point to a range above</h3>
                    <p id="info-range">20 Hz - 20 kHz</p>
                    <p id="info-desc">Explore how sound is divided across the spectrum. Hover over the colorful bars to
                        learn more.</p>
                </div>
            </div>

            <div class="home-guide">
                <div class="guide-card">
                    <h4>Crossover Alignment?</h4>
                    <p><b>Butterworth:</b> Mathematically flat response. The most common choice.</p>
                    <p><b>Linkwitz-Riley:</b> Perfect for phase alignment. Tweeter and woofer work in sync.</p>
                </div>
                <div class="guide-card">
                    <h4>Orders & Slopes</h4>
                    <p><b>1st Order (6dB):</b> Gentle. Best for audiophile setups.</p>
                    <p><b>4th Order (24dB):</b> Sharp. Maximum protection for your drivers.</p>
                </div>
                <div class="guide-card" style="grid-column: span 2;">
                    <h4>What is a Band-Pass Filter?</h4>
                    <p>When using a <b>Midrange</b> driver, you often need to cut <i>both</i> the very low bass (to
                        protect the small driver) and the very high treble (to let the tweeter take over). This is
                        called a <b>Band-Pass</b> filter. Use the <b>Multi-Way</b> tab to design this!</p>
                </div>
            </div>
        </div>

        <div id="tone-view" class="tab-view hidden">
            <div class="result-card" style="max-width: 600px; margin: 0 auto;">
                <h2>Precision Tone Generator</h2>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">Test your crossover points and driver response
                    with specific frequencies.</p>

                <div class="input-section">
                    <div class="form-group">
                        <label>Frequency (Hz)</label>
                        <div class="input-row-grid" style="grid-template-columns: 1fr 2fr; align-items: center;">
                            <input type="number" id="tone-freq-input" value="1000" min="20" max="20000" step="1">
                            <input type="range" id="tone-freq-slider" min="20" max="20000" value="1000" class="slider">
                        </div>
                    </div>

                    <div class="input-row-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label>Waveform</label>
                            <select id="tone-type">
                                <option value="sine">Sine (Pure Tone)</option>
                                <option value="square">Square</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="triangle">Triangle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Volume</label>
                            <input type="range" id="tone-volume" min="0" max="0.5" step="0.01" value="0.1"
                                class="slider">
                        </div>
                    </div>

                    <button id="tone-toggle-btn" style="background: var(--accent); margin-top: 1rem; width: 100%;">START
                        TONE</button>

                    <div class="alert warning" style="margin-top: 2rem;">
                        <b>Safety First:</b> Tweeters can be damaged by high-power low frequencies. Start with low
                        volume.
                    </div>
                </div>
            </div>
        </div>

        <div id="calculator-view" class="tab-view hidden">
            <div class="main-grid">
                <section class="input-section">
                    <!-- Design Intent Selector -->
                    <div class="form-group">
                        <label for="intent">Design Intent</label>
                        <select id="intent">
                            <option value="Flat / Reference">Flat / Reference</option>
                            <option value="Warm">Warm (Relaxed Highs)</option>
                            <option value="Bright">Bright (Detailed Highs)</option>
                            <option value="Vocal Forward">Vocal Forward</option>
                        </select>
                        <span class="input-hint">Adjusts the overall sound character.</span>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label for="type">Crossover Type (Alignment)</label>
                        <select id="type">
                            <option value="1st Order Butterworth">1st Order Butterworth (6dB)</option>
                            <option value="2nd Order Butterworth" selected>2nd Order Butterworth (12dB)</option>
                            <option value="2nd Order Linkwitz-Riley">2nd Order Linkwitz-Riley (12dB)</option>
                            <option value="2nd Order Bessel">2nd Order Bessel (12dB)</option>
                            <option value="3rd Order Butterworth">3rd Order Butterworth (18dB)</option>
                            <option value="4th Order Linkwitz-Riley">4th Order Linkwitz-Riley (24dB)</option>
                        </select>
                        <span class="input-hint">Affects how sharply frequencies roll off and how drivers align in
                            phase.</span>
                    </div>

                    <!-- Simple 2-Way Inputs -->
                    <div id="simple-inputs" class="tab-content">
                        <h2>Textbook 2-Way</h2>
                        <div class="form-group">
                            <label for="tweeter-imp">Tweeter Impedance (Ω)</label>
                            <input type="number" id="tweeter-imp" value="8" step="0.1" min="1">
                            <span class="input-hint">Nominal resistance (usually 4 or 8Ω). Typical: 8Ω for home
                                speakers.</span>
                        </div>
                        <div class="form-group">
                            <label for="tweeter-fs">Tweeter Fs (Hz) - <span
                                    style="font-size: 0.7rem; color: var(--text-muted);">Optional for
                                    safety</span></label>
                            <input type="number" id="tweeter-fs" placeholder="e.g. 1000" step="1">
                            <span class="input-hint">Found in datasheet as 'Fs'. Typical: 1000Hz. Used for safety
                                margins.</span>
                        </div>
                        <div class="form-group">
                            <label for="woofer-imp">Woofer Impedance (Ω)</label>
                            <input type="number" id="woofer-imp" value="8" step="0.1" min="1">
                            <span class="input-hint">Nominal resistance (usually 4 or 8Ω). Typical: 8Ω for home
                                speakers.</span>
                        </div>
                        <div class="form-group">
                            <label for="freq">Crossover Frequency (Hz)</label>
                            <input type="number" id="freq" value="3000" step="10" min="20">
                            <span class="input-hint">The "hand-off" point between woofer and tweeter. Common range: 2000
                                -
                                3500 Hz.</span>
                        </div>
                    </div>

                    <!-- Advanced Inputs (L-Pad / Zobel) -->
                    <div id="advanced-inputs" class="tab-content hidden">
                        <h2>Real-World Correction</h2>
                        <div class="form-group">
                            <label>L-Pad (Tweeter Atten.)</label>
                            <div class="input-row-grid" style="grid-template-columns: 1fr 1fr;">
                                <input type="number" id="lpad-imp" placeholder="Imp (8)" step="0.1">
                                <input type="number" id="lpad-db" placeholder="dB (3)" step="0.1">
                            </div>
                            <span class="input-hint">Matches tweeter volume to woofer. Typical reduction: 3 to 6
                                dB.</span>
                        </div>
                        <div class="form-group">
                            <label>Zobel (Woofer Comp.)</label>
                            <div class="input-row-grid" style="grid-template-columns: 1fr 1fr;">
                                <input type="number" id="zobel-re" placeholder="Re (ohms)" step="0.1">
                                <input type="number" id="zobel-le" placeholder="Le (mH)" step="0.01">
                            </div>
                            <span class="input-hint">Corrects rising impedance. Typical for 8Ω woofer: Re 6.5, Le
                                0.8.</span>
                        </div>
                    </div>

                    <!-- Complex Inputs (3-Way) -->
                    <div id="complex-inputs" class="tab-content hidden">
                        <h2>3-Way / Band-Pass Designer</h2>
                        <div class="alert note"
                            style="margin-bottom: 1.5rem; background: rgba(129, 140, 248, 0.1); border: 1px solid rgba(129, 140, 248, 0.2); padding: 0.8rem; border-radius: 10px; font-size: 0.85rem; color: #a5b4fc;">
                            <b>Pro Tip:</b> For a 2-way system using a <b>Midrange + Tweeter</b>, enter 0 for the Woofer
                            impedance. This tab will calculate the <b>Band-Pass</b> filter your Midrange needs.
                        </div>
                        <div class="form-group">
                            <label>Impedances (Ω)</label>
                            <div class="input-row-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                                <input type="number" id="w3-rt" placeholder="TW" step="0.1">
                                <input type="number" id="w3-rm" placeholder="MID" step="0.1">
                                <input type="number" id="w3-rw" placeholder="WF" step="0.1">
                            </div>
                            <span class="input-hint">Speaker impedances (usually 8Ω).</span>
                        </div>
                        <div class="form-group">
                            <label>Freqs (Hz)</label>
                            <div class="input-row-grid" style="grid-template-columns: 1fr 1fr;">
                                <input type="number" id="w3-flz" placeholder="Low (500)">
                                <input type="number" id="w3-fhz" placeholder="High (3500)">
                            </div>
                            <span class="input-hint">Typical Hand-offs: 500Hz (Low) and 3500Hz (High).</span>
                        </div>
                    </div>

                    <button id="calc-btn">Calculate Components</button>

                    <div id="alerts-container" class="alerts-container"></div>
                    <div id="intent-tip" class="intent-tip hidden"></div>
                </section>

                <section class="results-section">
                    <div class="result-card" id="tweeter-card">
                        <h3>Tweeter Network</h3>
                        <div class="component-list" id="tweeter-list">
                            <div class="component-item">
                                <span class="comp-name">C1</span>
                                <span class="comp-value">-- <span class="unit">uF</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="result-card hidden" id="midrange-card">
                        <h3>Midrange Network</h3>
                        <div class="component-list" id="midrange-list">
                            <div class="component-item">
                                <span class="comp-name">C2</span>
                                <span class="comp-value">-- <span class="unit">uF</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="result-card" id="woofer-card">
                        <h3>Woofer Network</h3>
                        <div class="component-list" id="woofer-list">
                            <div class="component-item">
                                <span class="comp-name">L1</span>
                                <span class="comp-value">-- <span class="unit">mH</span></span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Simplified schematic area -->
            <!-- Schematic Area -->
            <div class="schematic-container">
                <h3>Network Schematic</h3>
                <div id="schematic-svg-wrapper">
                    <svg id="schematic-svg" viewBox="0 0 600 300" preserveAspectRatio="xMidYMid meet">
                        <!-- Dynamic content -->
                    </svg>
                </div>
            </div>

            <div id="schematic-info"
                style="margin-top: 2rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">
                Calculations are based on ideal driver impedances.
            </div>
        </div>

        <script type="module">
            import { calculateCrossover, calculateLPad, calculateZobel, calculate3Way, validateSafety, getIntentGuidance, CROSSOVER_TYPES, DESIGN_INTENTS } from './calculator.js';

            const btn = document.getElementById('calc-btn');
            const rhInput = document.getElementById('tweeter-imp');
            const fsInput = document.getElementById('tweeter-fs');
            const rlInput = document.getElementById('woofer-imp');
            const fInput = document.getElementById('freq');
            const typeSelect = document.getElementById('type');
            const intentSelect = document.getElementById('intent');
            const tweeterList = document.getElementById('tweeter-list');
            const midrangeList = document.getElementById('midrange-list');
            const wooferList = document.getElementById('woofer-list');
            const tweeterCard = document.getElementById('tweeter-card');
            const midrangeCard = document.getElementById('midrange-card');
            const wooferCard = document.getElementById('woofer-card');

            const svg = document.getElementById('schematic-svg');
            const alertsContainer = document.getElementById('alerts-container');
            const intentTip = document.getElementById('intent-tip');

            // Tab Logic
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const tabViews = document.querySelectorAll('.tab-view');
            let activeTab = 'home';

            tabBtns.forEach(tabBtn => {
                tabBtn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabBtn.classList.add('active');

                    activeTab = tabBtn.dataset.tab;

                    if (activeTab === 'home') {
                        document.getElementById('home-view').classList.remove('hidden');
                        document.getElementById('tone-view').classList.add('hidden');
                        document.getElementById('calculator-view').classList.add('hidden');
                    } else if (activeTab === 'tone') {
                        document.getElementById('home-view').classList.add('hidden');
                        document.getElementById('tone-view').classList.remove('hidden');
                        document.getElementById('calculator-view').classList.add('hidden');
                    } else {
                        document.getElementById('home-view').classList.add('hidden');
                        document.getElementById('tone-view').classList.add('hidden');
                        document.getElementById('calculator-view').classList.remove('hidden');

                        // Toggle Midrange Card
                        if (activeTab === 'complex') {
                            midrangeCard.classList.remove('hidden');
                        } else {
                            midrangeCard.classList.add('hidden');
                        }

                        tabContents.forEach(content => {
                            content.classList.add('hidden');
                            if (content.id === `${activeTab}-inputs`) content.classList.remove('hidden');
                        });
                        updateResults();
                    }
                });
            });

            // Spectrum Interaction Logic
            const bands = document.querySelectorAll('.chart-band');
            const infoName = document.getElementById('info-name');
            const infoRange = document.getElementById('info-range');
            const infoDesc = document.getElementById('info-desc');

            bands.forEach(band => {
                band.addEventListener('mouseenter', () => {
                    infoName.textContent = band.dataset.name;
                    infoRange.textContent = band.dataset.range;
                    infoDesc.textContent = band.dataset.desc;
                });
            });

            function drawSchematic(type) {
                svg.innerHTML = '';
                const isComplex = activeTab === 'complex';
                const rw = isComplex ? parseFloat(document.getElementById('w3-rw').value) || 0 : 8;
                const rm = isComplex ? parseFloat(document.getElementById('w3-rm').value) || 0 : 0;
                const rt = isComplex ? parseFloat(document.getElementById('w3-rt').value) || 8 : 8;

                // Determine Order
                let order = 2;
                if (type.includes('1st')) order = 1;
                else if (type.includes('2nd')) order = 2;
                else if (type.includes('3rd')) order = 3;
                else if (type.includes('4th')) order = 4;

                const p = isComplex ? { tw: 'T-', mid: 'M-', woof: 'W-' } : { tw: '', mid: '', woof: '' };

                // SVG Header & Shared Elements
                svg.innerHTML = `
                    <defs>
                        <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8" />
                        </marker>
                    </defs>
                    <line x1="50" y1="260" x2="550" y2="260" stroke="#94a3b8" stroke-width="2" />
                    <circle cx="50" cy="50" r="4" fill="#818cf8" />
                    <circle cx="50" cy="260" r="4" fill="#818cf8" />
                    <text x="30" y="55" fill="#818cf8" font-size="12" font-weight="bold">+</text>
                    <text x="30" y="265" fill="#818cf8" font-size="12" font-weight="bold">-</text>
                `;

                function drawDriverLeg(y, drType) {
                    const pref = p[drType];
                    let html = `<line x1="50" y1="50" x2="50" y2="${y}" stroke="#d1d5db" stroke-width="2" />`;

                    if (drType === 'tw') {
                        if (order === 1) { // C1
                            html += `<line x1="50" y1="50" x2="150" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="150" y1="35" x2="150" y2="65" stroke="#10b981" stroke-width="3" />
                                     <line x1="160" y1="35" x2="160" y2="65" stroke="#10b981" stroke-width="3" />
                                     <text x="145" y="30" fill="#10b981" font-size="10">${pref}C1</text>
                                     <line x1="160" y1="50" x2="400" y2="50" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 2) { // C1, L1(shunt)
                            html += `<line x1="50" y1="50" x2="120" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="120" y1="35" x2="120" y2="65" stroke="#10b981" stroke-width="3" />
                                     <line x1="130" y1="35" x2="130" y2="65" stroke="#10b981" stroke-width="3" />
                                     <text x="115" y="30" fill="#10b981" font-size="10">${pref}C1</text>
                                     <line x1="130" y1="50" x2="200" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="200" y1="50" x2="200" y2="70" stroke="#d1d5db" stroke-width="2" />
                                     <path d="M 200 70 Q 185 75 200 80 Q 185 85 200 90 Q 185 95 200 100" fill="none" stroke="#f59e0b" stroke-width="3" />
                                     <text x="205" y="90" fill="#f59e0b" font-size="10">${pref}L1</text>
                                     <line x1="200" y1="100" x2="200" y2="260" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="200" y1="50" x2="400" y2="50" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 3) { // C1, L2(shunt), C3
                            html += `<line x1="50" y1="50" x2="100" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="100" y1="35" x2="100" y2="65" stroke="#10b981" stroke-width="3" />
                                     <line x1="108" y1="35" x2="108" y2="65" stroke="#10b981" stroke-width="3" />
                                     <text x="95" y="30" fill="#10b981" font-size="9">${pref}C1</text>
                                     <line x1="108" y1="50" x2="180" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="180" y1="50" x2="180" y2="70" stroke="#d1d5db" stroke-width="2" />
                                     <path d="M 180 70 Q 165 75 180 80 Q 165 85 180 90 Q 165 95 180 100" fill="none" stroke="#f59e0b" stroke-width="3" />
                                     <text x="185" y="90" fill="#f59e0b" font-size="9">${pref}L2</text>
                                     <line x1="180" y1="100" x2="180" y2="260" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="180" y1="50" x2="260" y2="50" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="260" y1="35" x2="260" y2="65" stroke="#10b981" stroke-width="3" />
                                     <line x1="268" y1="35" x2="268" y2="65" stroke="#10b981" stroke-width="3" />
                                     <text x="255" y="30" fill="#10b981" font-size="9">${pref}C3</text>
                                     <line x1="268" y1="50" x2="400" y2="50" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 4) { // Simplified dash for 4th
                            html += `<line x1="50" y1="50" x2="400" y2="50" stroke="#d1d5db" stroke-width="2" stroke-dasharray="2,2" />
                                     <text x="220" y="45" fill="#94a3b8" font-size="9">4th Order Sections (${pref}C1,${pref}C2,L3,L4)</text>`;
                        }
                        // Driver
                        html += `<rect x="400" y="30" width="40" height="40" fill="none" stroke="#94a3b8" stroke-width="2" />
                                 <text x="405" y="55" fill="#94a3b8" font-size="10">TW</text>
                                 <line x1="440" y1="50" x2="520" y2="50" stroke="#d1d5db" stroke-width="2" />
                                 <line x1="520" y1="50" x2="520" y2="260" stroke="#d1d5db" stroke-width="2" />`;
                    }

                    if (drType === 'woof' && rw > 0) {
                        html += `<line x1="50" y1="220" x2="100" y2="220" stroke="#d1d5db" stroke-width="2" />`;
                        if (order === 1) { // L1
                            html += `<path d="M 100 220 Q 105 200 110 220 Q 115 200 120 220 Q 125 200 130 220" fill="none" stroke="#f59e0b" stroke-width="3" />
                                      <text x="105" y="200" fill="#f59e0b" font-size="10">${pref}L1</text>
                                      <line x1="130" y1="220" x2="400" y2="220" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 2) { // L2, C2 (shunt)
                            html += `<path d="M 100 220 Q 105 200 110 220 Q 115 200 120 220 Q 125 200 130 220" fill="none" stroke="#f59e0b" stroke-width="3" />
                                      <text x="105" y="200" fill="#f59e0b" font-size="10">${pref}L2</text>
                                      <line x1="130" y1="220" x2="200" y2="220" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="200" y1="220" x2="200" y2="235" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="190" y1="235" x2="210" y2="235" stroke="#10b981" stroke-width="3" />
                                      <line x1="190" y1="243" x2="210" y2="243" stroke="#10b981" stroke-width="3" />
                                      <text x="215" y="245" fill="#10b981" font-size="10">${pref}C2</text>
                                      <line x1="200" y1="243" x2="200" y2="260" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="200" y1="220" x2="400" y2="220" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 3) { // L1, C2(shunt), L3
                            html += `<path d="M 100 220 Q 105 200 110 220 Q 115 200 120 220 Q 125 200 130 220" fill="none" stroke="#f59e0b" stroke-width="3" />
                                      <text x="105" y="200" fill="#f59e0b" font-size="9">${pref}L1</text>
                                      <line x1="130" y1="220" x2="180" y2="220" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="180" y1="220" x2="180" y2="235" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="170" y1="235" x2="190" y2="235" stroke="#10b981" stroke-width="3" />
                                      <line x1="170" y1="243" x2="190" y2="243" stroke="#10b981" stroke-width="3" />
                                      <text x="195" y="245" fill="#10b981" font-size="9">${pref}C2</text>
                                      <line x1="180" y1="243" x2="180" y2="260" stroke="#d1d5db" stroke-width="2" />
                                      <line x1="180" y1="220" x2="240" y2="220" stroke="#d1d5db" stroke-width="2" />
                                      <path d="M 240 220 Q 245 200 250 220 Q 255 200 260 220 Q 265 200 270 220" fill="none" stroke="#f59e0b" stroke-width="3" />
                                      <text x="245" y="200" fill="#f59e0b" font-size="9">${pref}L3</text>
                                      <line x1="270" y1="220" x2="400" y2="220" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 4) {
                            html += `<line x1="100" y1="220" x2="400" y2="220" stroke="#d1d5db" stroke-width="2" stroke-dasharray="2,2" />
                                      <text x="220" y="215" fill="#94a3b8" font-size="9">4th Order Sections (L1,L2,C3,C4)</text>`;
                        }
                        // Driver
                        html += `<rect x="400" y="200" width="60" height="40" fill="none" stroke="#94a3b8" stroke-width="2" />
                                 <text x="408" y="225" fill="#94a3b8" font-size="10">WOOF</text>
                                 <line x1="460" y1="220" x2="460" y2="260" stroke="#d1d5db" stroke-width="2" />`;
                    }

                    if (drType === 'mid' && rm > 0) {
                        html += `<line x1="50" y1="140" x2="80" y2="140" stroke="#d1d5db" stroke-width="2" />`;
                        if (order === 1) { // M-C1, M-L1
                            html += `<line x1="80" y1="125" x2="80" y2="155" stroke="#10b981" stroke-width="3" />
                                     <line x1="88" y1="125" x2="88" y2="155" stroke="#10b981" stroke-width="3" />
                                     <text x="75" y="120" fill="#10b981" font-size="9">${pref}C1</text>
                                     <line x1="88" y1="140" x2="140" y2="140" stroke="#d1d5db" stroke-width="2" />
                                     <path d="M 140 140 Q 145 120 150 140 Q 155 120 160 140 Q 165 120 170 140" fill="none" stroke="#f59e0b" stroke-width="3" />
                                     <text x="145" y="120" fill="#f59e0b" font-size="9">${pref}L1</text>
                                     <line x1="170" y1="140" x2="400" y2="140" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 2) { // M-C1, M-L1(shunt), M-L2, M-C2(shunt)
                            html += `<line x1="80" y1="125" x2="80" y2="155" stroke="#10b981" stroke-width="3" />
                                     <line x1="88" y1="125" x2="88" y2="155" stroke="#10b981" stroke-width="3" />
                                     <text x="75" y="120" fill="#10b981" font-size="9">${pref}C1</text>
                                     <line x1="88" y1="140" x2="140" y2="140" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="140" y1="140" x2="140" y2="155" stroke="#d1d5db" stroke-width="2" />
                                     <path d="M 140 155 Q 125 160 140 165 Q 125 170 140 175 Q 125 180 140 185" fill="none" stroke="#f59e0b" stroke-width="3" />
                                     <text x="145" y="175" fill="#f59e0b" font-size="9">${pref}L1</text>
                                     <line x1="140" y1="185" x2="140" y2="260" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="140" y1="140" x2="190" y2="140" stroke="#d1d5db" stroke-width="2" />
                                     <path d="M 190 140 Q 195 120 200 140 Q 205 120 210 140 Q 215 120 220 140" fill="none" stroke="#f59e0b" stroke-width="3" />
                                     <text x="195" y="120" fill="#f59e0b" font-size="9">${pref}L2</text>
                                     <line x1="220" y1="140" x2="270" y2="140" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="270" y1="140" x2="270" y2="155" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="260" y1="155" x2="280" y2="155" stroke="#10b981" stroke-width="3" />
                                     <line x1="260" y1="163" x2="280" y2="163" stroke="#10b981" stroke-width="3" />
                                     <text x="285" y="165" fill="#10b981" font-size="9">${pref}C2</text>
                                     <line x1="270" y1="163" x2="270" y2="260" stroke="#d1d5db" stroke-width="2" />
                                     <line x1="270" y1="140" x2="400" y2="140" stroke="#d1d5db" stroke-width="2" />`;
                        } else if (order === 3) { // 3rd Order BP cascade (Simplified but labeled)
                            html += `<line x1="80" y1="140" x2="400" y2="140" stroke="#d1d5db" stroke-width="2" stroke-dasharray="2,2" />
                                     <text x="180" y="135" fill="#94a3b8" font-size="9">3rd Order: ${pref}C1,${pref}L2,${pref}C3 | ${pref}L1,${pref}C2,${pref}L3</text>`;
                        } else {
                            html += `<line x1="80" y1="140" x2="400" y2="140" stroke="#d1d5db" stroke-width="2" stroke-dasharray="2,2" />
                                     <text x="180" y="135" fill="#94a3b8" font-size="9">Band-Pass Path (Order ${order})</text>`;
                        }
                        // Driver
                        html += `<rect x="400" y="120" width="50" height="40" fill="none" stroke="#94a3b8" stroke-width="2" />
                                 <text x="405" y="145" fill="#94a3b8" font-size="10">MID</text>
                                 <line x1="450" y1="140" x2="490" y2="140" stroke="#d1d5db" stroke-width="2" />
                                 <line x1="490" y1="140" x2="490" y2="260" stroke="#d1d5db" stroke-width="2" />`;
                    }
                    return html;
                }

                // Render Legs
                if (rt > 0) svg.innerHTML += drawDriverLeg(50, 'tw');
                if (rm > 0) svg.innerHTML += drawDriverLeg(140, 'mid');
                if (rw > 0) svg.innerHTML += drawDriverLeg(220, 'woof');
            }

            function updateResults() {
                alertsContainer.innerHTML = '';
                const intent = intentSelect.value;
                intentTip.textContent = getIntentGuidance(intent);
                intentTip.classList.remove('hidden');

                if (activeTab === 'simple') {
                    const rh = parseFloat(rhInput.value);
                    const rl = parseFloat(rlInput.value);
                    const f = parseFloat(fInput.value);
                    const fs = parseFloat(fsInput.value);
                    const type = typeSelect.value;

                    const results = calculateCrossover(rh, rl, f, type);
                    renderResults(results.highPass, results.lowPass);

                    // Add Coverage Labels
                    tweeterCard.querySelector('h3').innerHTML += ` <span class="coverage-label">${f}Hz+</span>`;
                    wooferCard.querySelector('h3').innerHTML += ` <span class="coverage-label">0-${f}Hz</span>`;

                    drawSchematic(type);

                    // Run Safety Validation
                    const warnings = validateSafety(rh, rl, f, fs, type);
                    warnings.forEach(w => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert ${w.type}`;
                        alertDiv.textContent = w.message;
                        alertsContainer.appendChild(alertDiv);
                    });
                }
                else if (activeTab === 'advanced') {
                    const resultHP = [];
                    const resultLP = [];

                    // Base Crossover
                    const rh = parseFloat(rhInput.value) || 8;
                    const rl = parseFloat(rlInput.value) || 8;
                    const f = parseFloat(fInput.value) || 3000;
                    const type = typeSelect.value;
                    const baseCross = calculateCrossover(rh, rl, f, type);
                    resultHP.push(...baseCross.highPass);
                    resultLP.push(...baseCross.lowPass);

                    // L-Pad
                    const lpadImp = parseFloat(document.getElementById('lpad-imp').value);
                    const lpadDb = parseFloat(document.getElementById('lpad-db').value);
                    if (lpadImp && lpadDb) {
                        const lpad = calculateLPad(lpadImp, lpadDb);
                        resultHP.push({ name: 'R1 (L-Pad)', value: lpad.r1, unit: 'Ω' });
                        resultHP.push({ name: 'R2 (L-Pad)', value: lpad.r2, unit: 'Ω' });
                    }

                    // Zobel
                    const zobelRe = parseFloat(document.getElementById('zobel-re').value);
                    const zobelLe = parseFloat(document.getElementById('zobel-le').value);
                    if (zobelRe && zobelLe) {
                        const zobel = calculateZobel(zobelRe, zobelLe);
                        resultLP.push({ name: 'Rz (Zobel)', value: zobel.rz, unit: 'Ω' });
                        resultLP.push({ name: 'Cz (Zobel)', value: zobel.cz, unit: 'uF' });
                    }
                    renderResults(resultHP, resultLP);
                    drawSchematic(type);
                }
                else if (activeTab === 'complex') {
                    const rt = parseFloat(document.getElementById('w3-rt').value) || 8;
                    const rm = parseFloat(document.getElementById('w3-rm').value) || 8;
                    const rw = parseFloat(document.getElementById('w3-rw').value) || 8;
                    const flz = parseFloat(document.getElementById('w3-flz').value) || 500;
                    const fhz = parseFloat(document.getElementById('w3-fhz').value) || 3500;
                    const type = typeSelect.value;

                    const results = calculate3Way(rw, rm, rt, flz, fhz, type);

                    tweeterList.innerHTML = results.tweeter.map(comp => `<div class="component-item"><span class="comp-name">${comp.name}</span><span class="comp-value">${comp.value} ${comp.unit}</span></div>`).join('');
                    midrangeList.innerHTML = results.midrange.map(comp => `<div class="component-item"><span class="comp-name">${comp.name}</span><span class="comp-value">${comp.value} ${comp.unit}</span></div>`).join('');
                    wooferList.innerHTML = results.woofer.map(comp => `<div class="component-item"><span class="comp-name">${comp.name}</span><span class="comp-value">${comp.value} ${comp.unit}</span></div>`).join('');

                    tweeterCard.querySelector('h3').innerHTML = `Tweeter Network <span class="coverage-label">${fhz}Hz+</span>`;
                    midrangeCard.querySelector('h3').innerHTML = `Midrange Network <span class="coverage-label">${flz}-${fhz}Hz</span>`;

                    if (rw > 0) {
                        wooferCard.classList.remove('hidden');
                        wooferCard.querySelector('h3').innerHTML = `Woofer Network <span class="coverage-label">0-${flz}Hz</span>`;
                    } else {
                        wooferCard.classList.add('hidden');
                    }

                    drawSchematic(type);
                }
            }

            function renderResults(hp, lp) {
                tweeterCard.querySelector('h3').innerHTML = `Tweeter Network`;
                wooferCard.querySelector('h3').innerHTML = `Woofer Network`;

                tweeterList.innerHTML = hp.map(comp => `
                <div class="component-item">
                    <span class="comp-name">${comp.name}</span>
                    <span class="comp-value">${comp.value} <span class="unit">${comp.unit}</span></span>
                </div>
            `).join('');

                wooferList.innerHTML = lp.map(comp => `
                <div class="component-item">
                    <span class="comp-name">${comp.name}</span>
                    <span class="comp-value">${comp.value} <span class="unit">${comp.unit}</span></span>
                </div>
            `).join('');
            }

            // Tone Generator Logic
            let audioCtx = null;
            let oscillator = null;
            let gainNode = null;
            let isPlaying = false;

            const toneToggleBtn = document.getElementById('tone-toggle-btn');
            const freqInput = document.getElementById('tone-freq-input');
            const freqSlider = document.getElementById('tone-freq-slider');
            const toneType = document.getElementById('tone-type');
            const toneVol = document.getElementById('tone-volume');

            function initAudio() {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioCtx.createGain();
                gainNode.connect(audioCtx.destination);
                gainNode.gain.setValueAtTime(toneVol.value, audioCtx.currentTime);
            }

            function startTone() {
                if (!audioCtx) initAudio();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                oscillator = audioCtx.createOscillator();
                oscillator.type = toneType.value;
                oscillator.frequency.setValueAtTime(freqInput.value, audioCtx.currentTime);
                oscillator.connect(gainNode);
                oscillator.start();
                isPlaying = true;
                toneToggleBtn.textContent = 'STOP TONE';
                toneToggleBtn.style.background = '#ef4444'; // Red for stop
            }

            function stopTone() {
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                    oscillator = null;
                }
                isPlaying = false;
                toneToggleBtn.textContent = 'START TONE';
                toneToggleBtn.style.background = 'var(--accent)';
            }

            toneToggleBtn.addEventListener('click', () => {
                if (isPlaying) stopTone();
                else startTone();
            });

            // Synchronize Input & Slider
            freqInput.addEventListener('input', () => {
                freqSlider.value = freqInput.value;
                if (oscillator) oscillator.frequency.setTargetAtTime(freqInput.value, audioCtx.currentTime, 0.05);
            });

            freqSlider.addEventListener('input', () => {
                freqInput.value = freqSlider.value;
                if (oscillator) oscillator.frequency.setTargetAtTime(freqSlider.value, audioCtx.currentTime, 0.05);
            });

            toneVol.addEventListener('input', () => {
                if (gainNode) gainNode.gain.setTargetAtTime(toneVol.value, audioCtx.currentTime, 0.05);
            });

            toneType.addEventListener('change', () => {
                if (oscillator) oscillator.type = toneType.value;
            });

            btn.addEventListener('click', updateResults);
            updateResults();
        </script>
    </div>
</body>

</html>